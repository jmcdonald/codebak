# Security CI workflow for codebak
# Runs vulnerability scanning, static analysis, and secret detection

name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for TruffleHog

      - uses: actions/setup-go@v5
        with:
          go-version: "stable"

      - name: Check vulnerable dependencies
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          extra_args: --only-verified

      - name: Run gosec security scanner
        uses: securego/gosec@master
        with:
          # Exclusions for backup utility:
          # - G301/G306: Intentional 0755/0644 permissions for readable backups
          # - G304: Filesystem adapter must accept user paths (that's its purpose)
          # - G305: False positive - ZipSlip protection exists in isWithinDir()
          # - G110: Decompression from own backups is expected behavior
          args: -exclude=G301,G304,G305,G306,G110 ./...
